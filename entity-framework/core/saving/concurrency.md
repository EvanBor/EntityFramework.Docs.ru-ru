---
title: "Обработка конфликтов параллелизма - EF Core"
author: rowanmiller
ms.author: divega
ms.date: 03/03/2018
ms.technology: entity-framework-core
uid: core/saving/concurrency
ms.openlocfilehash: 288d9c6fced5ebbaa2c366248c68547502c3698e
ms.sourcegitcommit: 8f3be0a2a394253efb653388ec66bda964e5ee1b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2018
---
# <a name="handling-concurrency-conflicts"></a>Обработка конфликтов параллелизма

> [!NOTE]
> Этой странице документах как параллелизма работает в ядре EF и способов обработки конфликтов параллелизма в приложении. В разделе [маркеры параллелизма](xref:core/modeling/concurrency) подробные сведения о настройке маркеры параллелизма в модели.

> [!TIP]
> Для этой статьи вы можете скачать [пример](https://github.com/aspnet/EntityFramework.Docs/tree/master/samples/core/Saving/Saving/Concurrency/) из репозитория GitHub.

_Параллелизм баз данных_ относится к ситуации, в которых несколько процессов или пользователям доступ, или изменить те же данные в базе данных в то же время. _Управление параллелизмом_ ссылается на определенные механизмами для обеспечения согласованности данных при наличии параллельных изменений.

Реализует основные EF _управления оптимистичным параллелизмом_, означающего, что оно позволит несколько процессов и пользователей изменять независимо друг от друга без необходимости проведения синхронизации или блокировки. В идеальном случае эти изменения не будут конфликтовать друг с другом и поэтому сможет завершиться успешно. В худшем случае двух или более процессов попытается установить конфликтующих изменений, и только один из них должны выполняться успешно.

## <a name="how-concurrency-control-works-in-ef-core"></a>Как работает управление параллелизмом в EF Core

Свойства, настроенные как маркеры параллелизма используются для реализации управления оптимистичным параллелизмом: каждый раз, когда выполняется операция обновления или удаления во время `SaveChanges`, маркер параллелизма для базы данных сравнивается с исходным значение, считываемых EF Core.

- Если значения совпадают, операция может завершиться.
- Если значения не совпадают, EF Core предполагается, что другой пользователь выполнил конфликтует с операцией и прерывает текущую транзакцию.

Ситуации, когда другой пользователь выполнил операцию, которая конфликтует с текущей операцией называется _конфликт параллелизма_.

Поставщики базы данных — за реализацию сравнения значений маркера параллелизма.

В реляционных базах данных EF Core включает проверку для значения маркера параллелизма в `WHERE` предложение любого `UPDATE` или `DELETE` инструкции. После выполнения инструкций, EF Core считывает число строк, которые были затронуты.

Если не задействована, обнаруживается конфликт параллелизма и вызывает EF Core `DbUpdateConcurrencyException`.

Например, следует настроить `LastName` на `Person` быть маркера параллелизма. Все операции обновления на пользователя будет включать проверка параллелизма в `WHERE` предложения:

``` sql
UPDATE [Person] SET [FirstName] = @p1
WHERE [PersonId] = @p0 AND [LastName] = @p2;
```

## <a name="resolving-concurrency-conflicts"></a>Разрешение конфликтов параллелизма

Продолжение предыдущего примера, если один пользователь пытается сохранить некоторые изменения в `Person`, но уже была изменена другим пользователем `LastName` будет вызвано исключение.

На этом этапе приложение может просто информировать пользователей о том, что обновление не выполнена из-за конфликтующих изменений и перейти. Однако она может возникнуть необходимость запрашивать пользователя Убедитесь, что эта запись по-прежнему представляет фактический неизменность и повторите операцию.

Этот процесс является примером _разрешение конфликтов параллелизма_.

Разрешение конфликтов параллелизма включает в себя объединение ожидающие обработки изменения из текущего `DbContext` со значениями в базе данных. Объединить какие значения будут зависеть от приложения и могут быть перенаправлены вводимыми пользователем.

**Существуют три набора значений, который помогает разрешить конфликт параллелизма.**

* **Текущие значения** — это значения, при попытке приложения записать в базу данных.

* **Исходные значения** — это значения, изначально извлеченные из базы данных, перед были внесены изменения.

* **Базы данных значения** являются значения, которые хранятся в базе данных.

— Общий подход для обработки конфликтов параллелизма:

1. Catch `DbUpdateConcurrencyException` во время `SaveChanges`.
2. Используйте `DbUpdateConcurrencyException.Entries` подготовить новый набор изменений для затронутых объектов.
3. Обновите исходные значения маркера параллелизма в соответствии с текущими значениями в базе данных.
4. Повторите процесс, пока не возникают.

В следующем примере `Person.FirstName` и `Person.LastName` маркеры параллелизма, которые являются программы установки. Отсутствует `// TODO:` комментария в расположении, где содержат определенную логику приложения выберите значение для сохранения.

[!code-csharp[Main](../../../samples/core/Saving/Saving/Concurrency/Sample.cs?name=ConcurrencyHandlingCode&highlight=34-35)]
